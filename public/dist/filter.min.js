/*
 * filter.js
 * 2.0.0 (2014-12-23)
 *
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 * Copyright 2011-2014 Jiren Patel[jirenpatel@gmail.com]
 *
 * Dependency:
 *  jQuery(v1.9 >=)
 */
/*
 * JsonQuery
 * version: 0.0.2 (15/8/2014)
 *
 * Licensed under the MIT:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Copyright 2014 Jiren Patel[jirenpatel@gmail.com]
 *
 */
!function(t){"use strict";var e=function(t,e){return new n(t,e||{})};t.JsonQuery=e,e.VERSION="0.0.2",Object.defineProperty||(Object.defineProperty=function(t,e,r){t[e]=r.get});var r=function(t,e,r){if(t.length===+t.length)for(var i=0,n=t.length;n>i;i++)e.call(r,t[i],i);else for(var s in t)hasOwnProperty.call(t,s)&&e.call(r,t[s],s)},i=function(t,e,r){for(var i=0,n=t.length;n>i;i++)if(e.call(r,t[i],i)===!1)return},n=function(t,e){this.records=t||[],this.getterFns=e.getterFns||{},this.lat=e.latitude||"latitude",this.lng=e.longitude||"longitude",this.id=e.id,this.records.length&&a(this,t[0],e.schema)},s=n.prototype,a=function(t,e,r){t.schema={},t.id||(t.id=e._id?"_id":"id"),r||(h.call(t,e),o.call(t,e))},c=function(t){if(null==t)return"String";/*
     * @info Fix for IE 10 & 11
     * @bug Invalid calling object
     */
var e=Object.prototype.toString.call(t).slice(8,-1);return"String"==e&&t.match(/\d{4}-\d{2}-\d{2}/)?"Date":e},h=function(t,e){var r,i,n,s;for(r in t)s=t[r],i=c(s),n=e?e+"."+r:r,this.schema[n]=i,"Object"==i?h.call(this,s,n):"Array"==i&&(["Object","Array"].indexOf(c(s[0]))>-1?h.call(this,t[r][0],n):this.schema[n]=c(s[0]))},o=function(t){var e,r,i;for(e in this.schema){r=this.schema[e];try{this.getterFns[e]||(this.getterFns[e]=l.call(this,e,r)),//Remap if it is array
i=this.getterFns[e](t),"Array"==c(i)&&(this.schema[e]="Array")}catch(n){console.log("Error while generating getter function for selector : "+e+" NOTE: Define manually")}}},u=function(t,e){for(var r,i=0,n=0,s=e.length-1,a=e.length-1;a>=0;a--)r=e.slice(0,a+1).join("."),"Array"==t[r]&&s>a&&(i=a,n+=1);return n>1?i+1:-1},l=function(t){for(var e,r,i,n="",s=t.split("."),a=u(this.schema,s),c=s.length-1;c>=0;c--)e=s.slice(0,c+1).join("."),r="['"+s[c]+"']",n="Array"==this.schema[e]?a==c?r+(n.length?".map(function(r"+c+"){  objs.push(r"+c+n+")})":""):r+(n.length?".map(function(r"+c+"){  return r"+c+n+"})":""):r+n;return i=a>-1?"var objs = []; obj"+n+";"+("Date"==this.schema.path?"return parseDate(objs)":"return objs;"):"return "+("Date"==this.schema.path?"parseDate(obj"+n+");":"obj"+n+";"),new Function("obj",i)};s.operators={eq:function(t,e){return t==e},ne:function(t,e){return t!=e},lt:function(t,e){return e>t},lte:function(t,e){return e>=t},gt:function(t,e){return t>e},gte:function(t,e){return t>=e},"in":function(t,e){return e.indexOf(t)>-1},ni:function(t,e){return-1==e.indexOf(t)},li:function(t,e){return e.test(t)},bt:function(t,e){return t>=e[0]&&t<=e[1]}},s.addOperator=function(t,e){this.operators[t]=e};// rVal = Record Value
// cVal = Condition Value
var f=function(t,e,r){var i=0,n=t.length;for(i;n>i;i++)if(r(t[i],e))return!0};s.addCondition=function(t,e){this.operators[t]=e},s.getCriteria=function(t){var e=t.split(".$");return{field:e[0],operator:e[1]||"eq"}},s.setGetterFn=function(t,e){this.getterFns[t]=e},s.addRecords=function(t){return t&&t.length?("Array"==c(t)?this.records=this.records.concat(t):this.records.push(t),this.schema||a(this,t[0]),!0):!1},s._findAll=function(t,e,i,n){var s,a,c,h=[],o=this.getterFns[e];return"li"==n&&"string"==typeof i&&(i=new RegExp(i)),s=this.operators[n],"Array"==this.schema[e]&&(c=s,s=f),r(t,function(t){a=o(t),s(a,i,c)&&h.push(t)}),h},s.find=function(t,e){var r,n;return e||(e=t,t=this.id),n=this.getterFns[t],i(this.records,function(t){return n(t)==e?(r=t,!1):void 0}),r},r(["where","or","groupBy","select","pluck","limit","offset","order","uniq","near"],function(t){s[t]=function(){var e=new j(this,this.records);return e[t].apply(e,arguments),e}}),r(["count","first","last","all"],function(t){Object.defineProperty(s,t,{get:function(){return new j(this,this.records)[t]}})});var d=function(t,e,r){for(var i=0,n=r.length;n>i;i++)if(this.getterFns[r[i]](t)!==this.getterFns[r[i]](e))return!1;return!0},p=function(t,e){var r,i,n;for(r in t)i=this.jQ.getCriteria(r),n=this.jQ._findAll(n||e,i.field,t[r],i.operator);return n},g=function(t,e){{var i,n=this.jQ.getterFns[t],s={};e.length}return r(e,function(t){i=n(t),(s[i]||(s[i]=[])).push(t)}),s},v=function(t,e){for(var r,i,n=e.slice(0),s=0,a=t.length;a>s;s++)r=this.jQ.getterFns[t[s].field],i="asc"==t[s].direction?1:-1,n.sort(function(t,e){var n=r(t),s=r(e);return(s>n?-1:n>s?1:0)*i});return n},m=function(t,e){var i,n=this,s=[];return r(t,function(t){i=n.jQ.getterFns[t],r(e,function(e,r){(s[r]||(s[r]={}))[t]=i(e)})}),s},_=function(t,e){var i=this.jQ.getterFns[t],n=[];return r(e,function(t){n.push(i(t))}),n},b=function(t,e){var i=[],n=this;return"Object"!=c(e[0])?(r(e,function(t){-1==i.indexOf(t)&&i.push(t)}),i):(i.push(e[0]),r(e,function(e){for(var r=!1,s=0,a=i.length;a>s;s++)d.call(n.jQ,i[s],e,t)&&(r=!0);r||i.push(e)}),i)},j=function(t,e){return this.jQ=t,this.records=e,this.criteria={},this},y=j.prototype;y.each=function(t,e){r(this.exec()||[],t,e)},y.exec=y.toArray=function(t){var e;return this.criteria.all&&(e=this.records),this.criteria.where&&(e=p.call(this,this.criteria.where,e||this.records)),this.criteria.or&&(e=e.concat(p.call(this,this.criteria.or,this.records)),e=b.call(this,[this.jQ.id],e)),this.criteria.order&&(e=v.call(this,this.criteria.order,e||this.records)),this.criteria.near&&(e=k.call(this,this.criteria.near,e||this.records)),this.criteria.uniq&&(e=b.call(this,this.criteria.uniq,e||this.records)),this.criteria.select&&(e=m.call(this,this.criteria.select,e||this.records)),this.criteria.pluck&&(e=_.call(this,this.criteria.pluck,e||this.records)),this.criteria.limit&&(e=(e||this.records).slice(this.criteria.offset||0,(this.criteria.offset||0)+this.criteria.limit)),this.criteria.group_by&&(e=g.call(this,this.criteria.group_by,e||this.records)),t&&r(e||this.records,t),e||(e=this.records),this.jQ.onResult&&this.jQ.onResult(e,this.criteria),e};var F=function(t,e){var r;this.criteria[t]||(this.criteria[t]={});for(r in e)this.criteria[t][r]=e[r];return this};y.where=function(t){return F.call(this,"where",t)},y.or=function(t){return F.call(this,"or",t)},y.groupBy=function(t){return this.criteria.group_by=t,this},y.select=function(){return this.criteria.select=arguments,this},y.pluck=function(t){return this.criteria.pluck=t,this},y.limit=function(t){return this.criteria.limit=t,this},y.offset=function(t){return this.criteria.offset=t,this},y.order=function(t){var e;this.criteria.order=this.criteria.order||[];for(e in t)this.criteria.order.push({field:e,direction:t[e].toLowerCase()});return this},y.uniq=function(){return this.criteria.uniq=arguments.length>0?arguments:!0,this},Object.defineProperty(y,"count",{get:function(){this.criteria.count=!0;var t=this.exec();return"Array"==c(t)?this.exec().length:Object.keys(t).length}}),Object.defineProperty(y,"all",{get:function(){return this.criteria.all=!0,this.exec()}}),Object.defineProperty(y,"first",{get:function(){return this.criteria.first=!0,this.exec()[0]}}),Object.defineProperty(y,"last",{get:function(){this.criteria.last=!0;var t=this.exec();return t[t.length-1]}});//Geocoding
var x={redius:6371,toRad:function(t){return t*Math.PI/180}},O=function(t,e,r,i){var n=x.toRad(e-t),s=x.toRad(i-r),t=x.toRad(t),e=x.toRad(e),a=Math.sin(n/2)*Math.sin(n/2)+Math.sin(s/2)*Math.sin(s/2)*Math.cos(t)*Math.cos(e);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*x.redius},k=function(t,e){var i=[],n=this,s="mile"==t.unit?.6214:1,a=n.jQ.getterFns[n.jQ.lat],c=n.jQ.getterFns[n.jQ.lng];return r(e,function(e){e._distance=O(a(e),t.lat,c(e),t.lng)*s,e._distance<=t.distance&&i.push(e)}),i.sort(function(t,e){return t._distance<e._distance?-1:t._distance>e._distance?1:0}),i};y.near=function(t,e,r,i){return this.criteria.near={lat:t,lng:e,distance:r,unit:i||"km"},this},//Helpers
y.map=y.collect=function(t){var e,r=[];return this.exec(function(i){(e=t(i))&&r.push(e)}),r},y.sum=function(t){var e,i=0,n=this.jQ.getterFns[t];return this.criteria.group_by&&(e=!0,i={}),this.exec(function(t,s){e?(i[s]=0,r(t,function(t){i[s]=i[s]+(n(t)||0)})):i+=n(t)||0}),i},y.toJQ=function(){var t=e(this.all,{schema:!0});return t.schema=this.jQ.schema,t.getterFns=this.jQ.getterFns,t}}(this),//In IE indexOf method not define.
Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){for(var r=e||0,i=this.length;i>r;r++)if(this[r]===t)return r;return-1}),function(t,e){"use strict";var r=function(t,e,n){var s=new i(t,e,n);return r.list.push(s),s};r.VERSION="2.0.0",r.list=[],t.fn.filterjs=function(e,i){var n=t(this);n.data("fjs")||n.data("fjs",r(e,n,i))},e.FilterJS=r;var i=function(e,r,i){var n=this;this.opts=i||{},this.callbacks=this.opts.callbacks||{},this.$container=t(r),this.view=this.opts.view||a,this.templateFn=this.template(t(this.opts.template).html()),this.criterias=[],this._index=1,t.each(this.opts.criterias||[],function(){n.addCriteria(this)}),this.Model=JsonQuery(),this.Model.getterFns._fid=function(t){return t._fid},this.addRecords(e)},n=i.prototype;Object.defineProperty(n,"records",{get:function(){return this.Model.records}}),Object.defineProperty(n,"recordsCount",{get:function(){return this.Model.records.length}});//View Template
// Ref: Underscopre.js
//JavaScript micro-templating, similar to John Resig's implementation.
var s={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};n.template=function(t,e){var r=s,i="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(r.escape,function(t,e){return"',escapeStr("+e.replace(/\\'/g,"'")+"),'"}).replace(r.interpolate,function(t,e){return"',"+e.replace(/\\'/g,"'")+",'"}).replace(r.evaluate||null,function(t,e){return"');"+e.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",n=new Function("obj",i);return e?n(e):function(t){return n(t)}},//Callback
n.execCallback=function(t,e){this.callbacks[t]&&this.callbacks[t].call(this,e)},n.addCallback=function(t,e){t&&e&&(this.callbacks[t]=e)},//Add Data
n.addRecords=function(t){!!this.Model.schema;this.execCallback("beforeAddRecords",t),this.Model.addRecords(t)&&(this.has_scheme||this.initSearch(this.opts.search),this.render(t),this.filter()),this.execCallback("afterAddRecords",t)},n.removeRecords=function(e){var r;if(t.isPlainObject(e)?r=this.Model.where(e).pluck("_fid").all:t.isArray(e)&&(r=this.Model.where({"id.$in":e}).pluck("_fid").all),!r)return!1;for(var i,n=this.Model.records,s=0,a=r.length,c=n.length-1;c>-1&&(i=n[c]._fid,r.indexOf(i)>-1&&(n.splice(c,1),s++,t("#fjs_"+i).remove()),s!=a);c--);return this.execCallback("afterRemove"),!0};var a=function(t){return this.templateFn(t)};n.render=function(e){var r,i=this;if(e.length){this.execCallback("beforeRender",e);var n="beforeRecordRender";t.each(e,function(e){i.execCallback(n,this),this._fid=i._index++,r=t(t.trim(i.view.call(i,this,e))),r.attr("id","fjs_"+this._fid),r.addClass("fjs_item"),i.$container.append(r)})}};var c=function(t){var e=t.$ele,r=t.$ele.attr("type");return t.selector||("INPUT"==e.get(0).tagName?t.selector="checkbox"==r||"radio"==r?":checked":":input":"SELECT"==e.get(0).tagName&&(t.selector="select")),t.event||(t.event="checkbox"==r||"radio"==r?"click":"change"),t},h=function(e,r){t("body").on(e.event,e.ele,function(){r.filter()})};n.addCriteria=function(e){var r=this;return e?(t.isArray(e)?t.each(e,function(){o.call(r,this)}):o.call(r,e),!0):!1};// Add Filter criteria
// criteria: { ele: '#name', event: 'check', field: 'name', type: 'range' }
var o=function(e){return e&&e.field&&e.ele?(e.$ele=t(e.ele),e.$ele.length?(e=c(e),h(e,this),e._q=e.field+("range"==e.type?".$bt":""),e.active=!0,this.criterias.push(e),!0):!1):!1};n.removeCriteria=function(e){var r,i,n=this;t.each(n.criterias,function(t){this.field==e&&(i=t)}),i&&(r=this.criterias.splice(i,1)[0],t("body").off(r.event,r.ele))};var u=function(e,r){var i=this;e&&(t.isArray(e)||(e=[e]),t.each(e,function(){var e=this;t.each(i.criterias,function(){this.field==e&&(this.active=r)})}))};n.deactivateCriteria=function(t){u.call(self,t,!1)},n.activateCriteria=function(t){u.call(this,t,!0)};var l=function(e){var r=[];return e.$ele.filter(e.selector).each(function(){r.push(t(this).val())}),"range"==e.type&&(r=r[0].split("-")),r};n.lastResult=function(){return this.last_result||this.records},n.filter=function(){var e,r,i={};return t.each(this.criterias,function(){this.active&&(e=l(this),(e||e.length)&&(r=t.isArray(e)&&!this.type?this._q+".$in":this._q,i[r]=e))}),this.last_result=this.Model.where(i).all,this.searchFilter(this.last_result)?i:(this.show(this.last_result),this.execCallback("afterFilter",this.last_result),i)},//HideShow element
n.show=function(e){t(".fjs_item").hide();for(var r=0,i=e.length;i>r;r++)t("#fjs_"+e[r]._fid).show()};//Search
var f=function(e,r,i){t("body").on("keyup",e,function(){i.searchTimeoutId&&clearTimeout(i.searchTimeoutId),i.searchTimeoutId=setTimeout(function(){i.filter()},r)})};n.initSearch=function(e){(e||e.ele)&&(e.start_length||(this.opts.search.start_length=2),this.$search_ele=t(this.opts.search.ele),this.$search_ele.length&&(this.has_search=!0,this.searchFn=this.buildSearchFn(e.fields),f(e.ele,e.timeout||0,this)))},n.buildSearchFn=function(e){var r=this,i=[];return e?t.each(e,function(){i.push(r.Model.getterFns[this])}):t.each(r.Model.getterFns,function(t,e){i.push(e)}),function(t,e){t=t.toLocaleUpperCase();for(var r=0,n=i.length;n>r;r++)if((i[r](e)+"").toLocaleUpperCase().indexOf(t)>-1)return!0;return!1}},n.searchFilter=function(e){if(this.has_search){var r,i=t.trim(this.$search_ele.val());return i.length<this.opts.search.start_length?!1:(r=this.search(i,e||this.lastResult()),this.show(r),this.execCallback("afterFilter",r),!0)}},n.search=function(t,e){t=t.toLocaleUpperCase();for(var r=[],i=0,n=e.length;n>i;i++)this.searchFn(t,e[i])&&r.push(e[i]);return r},//Streaming
n.setStreaming=function(t){t&&(this.opts.streaming=t,t.data_url&&(t.stream_after=1e3*(t.stream_after||2),t.batch_size=t.batch_size||!1,this.streamData(t.stream_after)))};var d=function(){var e=this,r=this.opts.params||{},i=this.opts.streaming;r.offset=this.recordsCount,i.batch_size&&(r.limit=i.batch_size),this.has_search&&(r.q=t.trim(this.$search_ele.val())),t.getJSON(i.data_url,r).done(function(t){null==r.limit||t&&t.length?(e.setStreamInterval(),e.addRecords(t)):e.stopStreaming()}).fail(function(){e.stopStreaming()})};n.setStreamInterval=function(){var t=this;1!=t.opts.streaming.stop&&(t.streamingTimer=setTimeout(function(){d.call(t)},t.opts.streaming.stream_after))},n.stopStreaming=function(){this.opts.streaming.stop=!0,this.streamingTimer&&clearTimeout(this.streamingTimer)},n.resumeStreaming=function(){this.opts.streaming.stop=!1,this.streamData(this.opts.streaming.stream_after)},n.streamData=function(){this.setStreamInterval(),this.opts.streaming.batch_size||this.stopStreaming()}}(jQuery,window,document);